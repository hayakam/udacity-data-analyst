---
output:
  html_document: default
  pdf_document: default
---
Prosper Loan Data Exploration by Masa Hayakawa
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file, unless it makes sense for your
# report to show the code that generated a particular plot.

# The other parameters for "message" and "warning" should also be set to FALSE
# for other code chunks once you have verified that each plot comes out as you
# want it to. This will clean up the flow of your report.

#install.packages('ggplot2',dependencies = TRUE)
#install.packages('data.table')
#install.packages('dplyr')
#install.packages('GGally')
#install.packages('memisc')
#install.packages('lubridate')
#install.packages('gridExtra')
#install.packages("Amelia")
#install.packages("pscl")
#install.packages("ROCR")
#install.packages("caret")

library(ggplot2)
library(data.table)
library(dplyr)
library(GGally)
library(scales)
library(memisc)
library(MASS)
library(lattice)
library(lubridate)
library(gridExtra)
library(Amelia)
library(pscl)
library(ROCR)
library(caret)

```


```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data}

# Load the Data
pf <- read.csv('~/Downloads/Udacity/data/prosperLoanData.csv',na.strings=c(""))

### only pick up relevant fields and also filtering out records with missing loan status and cancelled status.

loandata <- subset(pf, pf$LoanStatus != 'Cancelled' & !is.na(pf$LoanStatus), 
                   select = c(LoanOriginalAmount, BorrowerRate, 
                              StatedMonthlyIncome, DebtToIncomeRatio, 
                              MonthlyLoanPayment, ProsperScore, IncomeRange, 
                              LoanStatus, EmploymentStatus, IsBorrowerHomeowner,
                              ProsperRating..Alpha., LoanOriginationDate,
                              ListingCategory..numeric., Term, 
                              ProsperRating..numeric., EmploymentStatusDuration, CurrentCreditLines, OpenRevolvingAccounts, OpenRevolvingMonthlyPayment,
                              TotalInquiries, 
                              CurrentDelinquencies,
                              RevolvingCreditBalance, BankcardUtilization, AvailableBankcardCredit, IncomeVerifiable,CreditScoreRangeLower
                              ))

### binning LoanOriginalAmount and StatedMonthlyIncome to avoid perfect separation warning
Amount_Ranges <- c("$0 - $999", "$1,000 - $1,999","$2,000 - $2,999", "$3,000 - $3,999", "$4,000 - $4,999", "$5,000 - $5,999", "$6,000 - $6,999", "$7,000 - $7,999", "$8,000 - $8,999", "$9,000 - $9,999", "$10,000 - $10,999", "$11,000 - $11,999", "$12,000 - $12,999", "$13,000 - $13,999", "$14,000 - $14,999", "$15,000 - $15,999", "$16,000 - $16,999","$17,000 - $17,999","$18,000 - $19,999", "$20,000 or more")


loandata$LoanOriginalAmountRange <- cut(loandata$LoanOriginalAmount, c(-Inf, seq(2000,20000,1000), Inf), labels=Amount_Ranges, right=F)

loandata$StatedMonthlyIncomeRange <- cut(loandata$StatedMonthlyIncome, c(-Inf, seq(2000,20000,1000), Inf), labels=Amount_Ranges, right=F)

```


This report explores Prosper Loan dataset that contain loan information for 
approximately 114,000 loan records.

# Data Wrangling Section

Before exploring analysis, I would like to deal with any missing values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
### Check if three are any missing values
missmap(loandata, main = "Missing values vs observed")

```

Above chart is showing there are some missing values with ProsperRating..numeric, ProsperRating..Alpha, ProsperScore, and DebtToIncomeRatio, and EmploymentStatus.

# Univariate Plots Section

First of all, in this section, I would like to perform some preliminary 
exploration of the dataset.

Original Prosper loan dataset contains approximately 114,000 observations and 81 variables.
I have created a subset from original data so that I can only focus on already closed loans. Also, I have picked up only necessary variables. 
Thus, the dataset in this report includes 55,084 observations with 16 variables as follows.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
loandata_completed <- subset(loandata, loandata$LoanStatus %in% c('Completed','Chargedoff','Defaulted'))

### adding new variables

# IsDefaulted: to be used to indicate whether or not the loan is either Completed or Chargedoff/Defaulted
loandata_completed$IsDefaulted <- ifelse(
  loandata_completed$LoanStatus == 'Defaulted' | 
    loandata_completed$LoanStatus == 'Chargedoff', 'Defaulted/Charge-off',
  'Completed')

loandata_completed$MonthlyIncomePaymentDiff <- ifelse(loandata_completed$StatedMonthlyIncome==0,0, (loandata_completed$StatedMonthlyIncome - loandata_completed$MonthlyLoanPayment)/loandata_completed$StatedMonthlyIncome)

### Replace NA in loandta_completed
loandata_completed$DebtToIncomeRatio <- ifelse(is.na(loandata_completed$DebtToIncomeRatio),0,loandata_completed$DebtToIncomeRatio)

loandata_completed$ProsperScore <- ifelse(is.na(loandata_completed$ProsperScore),0,loandata_completed$ProsperScore)

loandata_completed$ProsperRating..Alpha. <- ifelse(is.na(loandata_completed$ProsperRating..Alpha.),'NA',as.character(loandata_completed$ProsperRating..Alpha.))

loandata_completed$EmploymentStatusDuration <- ifelse(is.na(loandata_completed$EmploymentStatusDuration),0,loandata_completed$EmploymentStatusDuration)

loandata_completed$CurrentCreditLines <- ifelse(is.na(loandata_completed$CurrentCreditLines),0,loandata_completed$CurrentCreditLines)

loandata_completed$BankcardUtilization <- ifelse(is.na(loandata_completed$BankcardUtilization),0,loandata_completed$BankcardUtilization)

loandata_completed$RevolvingCreditBalance <- ifelse(is.na(loandata_completed$RevolvingCreditBalance),0,loandata_completed$RevolvingCreditBalance)

loandata_completed$AvailableBankcardCredit <- ifelse(is.na(loandata_completed$AvailableBankcardCredit),0,loandata_completed$AvailableBankcardCredit)

loandata_completed$TotalInquiries <- ifelse(is.na(loandata_completed$TotalInquiries),0,loandata_completed$TotalInquiries)

loandata_completed$CurrentDelinquencies <- ifelse(is.na(loandata_completed$CurrentDelinquencies),0,loandata_completed$CurrentDelinquencies)

loandata_completed$CreditScoreRangeLower <- ifelse(is.na(loandata_completed$CreditScoreRangeLower),0,loandata_completed$CreditScoreRangeLower)

unique(loandata_completed$CreditScoreRangeLower)
#mean(is.na(loandata_completed$DebtToIncomeRatio))                 
dim(loandata_completed)

```

Structure of the dataset is listed as follows:

```{r echo=FALSE, message=FALSE, warning=FALSE}

str(loandata_completed)

```


Summary of each variables are as follows:

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary(loandata_completed)

```


Now, I would like to look into the dataset. Firstly, I would like to explore some of the univariate plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### Histogram by Loan Amount
ggplot(aes(x = LoanOriginalAmount), data = loandata_completed)+
  geom_histogram()

### Histogram by Loan Amount with log 10
ggplot(aes(x = LoanOriginalAmount), data = loandata_completed)+
  geom_histogram(binwidth = 0.1) +
  scale_x_log10(breaks = seq(0,15000, 2000))+
  theme(axis.text.x = element_text(angle = 45, hjust =1))
  
```

First histogram is showing right skewed distribution. I have transformed the long tail data to better understand the distriution. 
The transformed loan amount distribution appears to have unimodal with peaks between 5,000 - 7,000.

I would like to look at other numerical variables as well.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### Histogram by Borrower Rate
ggplot(aes(x = BorrowerRate, binwidth = 0.1), data = loandata_completed)+
  geom_histogram()

```

Histogram by Borrwer rate is showing slightly right skewed unimodal distribution with its peak around 0.15.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### Histogram by Loan Term

ggplot(aes(x = Term, binwidth = 0.1), data = loandata_completed)+
  geom_histogram()

```

Histogram by loan term only shows 12, 36 and 60 months. Why are they so cloear cut? According to Prosper website[1], they seem to be offering only fixed term with either 3 or 5 years.

[1] https://www.prosper.com/ Prosper website


```{r echo=FALSE, message=FALSE, warning=FALSE}

### Histogram by Stated Monthly Income
ggplot(aes(x = StatedMonthlyIncome, binwidth = 0.1), data = loandata_completed)+
  geom_histogram() #+  scale_x_log10()

#qplot(x = StatedMonthlyIncome, data = loandata, binwidth = 0.05) 
# somehow this code took forever, not sure what is wrong with this one?

ggplot(aes(x = StatedMonthlyIncome), data = loandata_completed)+
  geom_histogram() +
  scale_x_continuous(limits = c(0, 10000), breaks = seq(0, 20000, 1000))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

* When looking by borrower's monthly income, there are some outliers in monthly income such as 618,548, as seen in the first plot.
* The second plot zoomed in under 10,000, the histogram shows slightly right skewed unimodal distribution. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary(loandata_completed$StatedMonthlyIncome)

```

* Summary shows that most of the borrower's monthly income are between 2,800 to 6,250, with average of 5,055 and median of 4,167.


Next, I would like to look across categorical variables.

Firstly let's look at the distribution by Income Range.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### by IncomeRange
ggplot(aes(x = IncomeRange), data = loandata_completed)+
  geom_histogram(stat='count')+
  scale_x_discrete(labels = abbreviate)

```


I was expecting to see more right skewed distribution, in ohter words, tendecy like borrower with lower income tend to borrow more. However, the plot shows unimodal distribution with peak around $25,000 and $50,000.


```{r echo=FALSE, message=FALSE, warning=FALSE}

### by Employment Status

ggplot(aes(x = EmploymentStatus), 
       data = loandata_completed)+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 90, hjust =1))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

mean(loandata_completed$EmploymentStatus %in% c('Employed','Full-time','Part-time','Self-employed'))
```

This plot shows distribution by Employment status. 82.4 % of the borrowers are employed in some form, i.e. either 'Employed','Full-time', 'Part-time', or 'Self-employed'.


```{r echo=FALSE, message=FALSE, warning=FALSE}

### by Homeowner
ggplot(aes(x = IsBorrowerHomeowner), data = loandata_completed)+
  geom_bar()

mean(loandata_completed$IsBorrowerHomeowner == 'True')
```

Above plot showing distribution by whether or not the borrower is home owner.
46.9% of the borrowers are home owners.

Next, let's have alook at distribution by risk indicators.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### by ProsperScore
ggplot(aes(x = ProsperScore), data = loandata_completed)+
  geom_bar()

summary(loandata_completed$ProsperScore)
```

Above plot by Prosper score is showing slightly left skewed unimodal distribution
with its peak around 8 with median of 6 and most of them are between 5 and 8.


```{r echo=FALSE, message=FALSE, warning=FALSE}

### by ProsperRating..Alpha.
rating_pos <- c('AA','A','B','C','D','E','HR')
ggplot(aes(x = ProsperRating..Alpha.), 
       data = subset(loandata_completed, 
                     loandata_completed$ProsperRating..Alpha. !=''))+
  geom_bar()+
  scale_x_discrete(limits = rating_pos)


```

This plot shows distribution by Prosper rating. Borrowers seem to be 
distributed almost equally across each ratings, except 'D' has the prominently 
high density.

Also listed the summary for each ratings as below.

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary(loandata_completed$LoanOriginalAmount)
by(loandata_completed$LoanOriginalAmount, 
   loandata_completed$ProsperRating..Alpha.,
   summary)

```

Finally, I would like to see what are the proportion of defaulted/charged-off 
loans.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### by Loan Status(COmpleted, Defaulted, or Charge-off)

ggplot(aes(x = LoanStatus), data = loandata_completed)+
  geom_bar()

### by Defaulted status

ggplot(aes(x = IsDefaulted), data = loandata_completed)+
  geom_bar()

```

The first plot shows the proportion of completed loans, defaulted loans, and 
charged-off loans.
In the second plot, I just combined defaulted loans and charge-off loans togerther, 
to compare with the completed loans.

```{r echo=FALSE, message=FALSE, warning=FALSE}

mean(loandata_completed$IsDefaulted=='Completed')

```
Almost 70 % of closed loans are completed without being defaulted/charge-off.




# Univariate Analysis

### What is the structure of your dataset?


Original Prosperloan dataset consists of 81 variables, with approximately 
114,000 observations. I have created a subset of 55,084 observations that have closed status and also only use 16 variables.


### What is/are the main feature(s) of interest in your dataset?


The main features of interest are Categorical factor variables listed as below:

* IncomeRange: $0, $1-24,999, $25,000-49,999, $50,000-74,999, $75,000-99,999 , 
$100,000+, 'Not displayed', and 'Not employed'
* LoanStatus: Cancelled,  Chargedoff, Completed, Current, Defaulted, 
FinalPaymentInProgress, PastDue
* EmploymentStatus: Employed, Full-time, Not available, Not employed, Other, 
Part-time, Retired, and Self-employed
* IsBorrowerHomeowner: TRUE, FALSE
* ProsperRating..Alpha.: (Higher -> Lower) AA, A, B, C, D, E, HR
* ProsperScore:  Ranges from 1-10, with 10 being the best

### What other features in the dataset do you think will help support your \ investigation into your feature(s) of interest?

Other variables such as BorrowerRate, StatedMonthlyIncome, DebtToIncomeRatio, MonthlyLoanPayment, and Term, likely contribute to further analysis.

### Did you create any new variables from existing variables in the dataset?

* IsDefaulted: 'Defaulted/Charge-off': defaulted or charged off, 'Completed': Completed, determined based on LoanStatus.


### Of the features you investigated, were there any unusual distributions? \
Did you perform any operations on the data to tidy, adjust, or change the form \
of the data? If so, why did you do this?

* LoanOriginalAmount: I have log-transformed the right skewed distribution in the second plot of this section.
* StatedMonthlyIncome: Histogram eliminated some outliers such as monthly income 
of 618,548 that appears to be unrealistic for a personal loan borrower.



------
    
# Bivariate Plots Section  
  
  
  
#### Correlations between variables


Firstly I have plotted a correlation matrix as below.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height = 10, fig.width = 15}

### plotting correlation matrix
set.seed(20022012)

### prepare a sample dataset
loandata_completed_samp <- subset(
  loandata_completed[complete.cases(loandata_completed),], 
  select = c(LoanOriginalAmount, BorrowerRate, StatedMonthlyIncome, 
             DebtToIncomeRatio, MonthlyLoanPayment, ProsperScore, 
             ProsperRating..numeric. 
))[sample(1:length(loandata_completed$LoanOriginalAmount), 10000), ]

### Correlation matrix
ggcorr(loandata_completed_samp, nbreaks = 20, label = TRUE, label_round = 4)
```

* Stated Monthly Income seems to have quite strong correlation with Prosper Rating(0.0697) and Prosper Score(0.0558).
* Borrower Rate also seems to have strong correlation with Stated Monthly Income(-0.0691).
* There also seems to be some correlation between loan amount and risk indicators such as Prosper rating and Prosper Score.

Now, I would like to look into the relation among individual variables more closely.

Firstly, I would like to see the relation between Prosper Score and Monthly Income, and also Prosper rating and monthly income, that are showing the strongest correlation in above chart.

```{r echo=FALSE, message=FALSE, warning=FALSE}

score_pos <- c('1','2','3','4','5',
               '6','7','8','9','10')


### box plot rating vs income
ggplot(aes(x = ProsperRating..Alpha., y = StatedMonthlyIncome), 
       data = loandata_completed)+
  geom_boxplot()+
  scale_y_continuous(limits = c(0,25000))+
  scale_x_discrete(limits = rating_pos)

### box plot Prosper score  vs income

ggplot(aes(x = as.character(ProsperScore), y = StatedMonthlyIncome), 
       data = loandata_completed)+
  geom_boxplot()+
  scale_y_continuous(limits = c(0,25000))+
  scale_x_discrete(limits = score_pos)


```

* The first plot shows the trend that the higher the bowroower's income, the better rating the borrowers get.
* Similar trend can be observed with Prosper score in the second plot, though it is not as drastic as wtih the rating.


Next, I would like to see how borrowers rate differs across Prosper rating and 
Prosper score.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### Boxplot by Prosper Rating
ggplot(aes(x = ProsperRating..Alpha., y = BorrowerRate), 
       data = loandata_completed)+
  geom_boxplot()+
  scale_x_discrete(limits = rating_pos)


### Boxplot by Prosper Score
score_pos <- c('1','2','3','4','5',
               '6','7','8','9','10')

ggplot(aes(x = as.character(ProsperScore), y = BorrowerRate), 
       data = subset(loandata_completed, ProsperScore < 11))+
  geom_boxplot()+
  scale_x_discrete(limits = score_pos)

``` 

* Seemingly, though each plot showing oppsite direction, both plots by rating and by score are showing predictable distribution. 
* The higher the risk, the higher loan rate the borrowers are charged.


Next, I would like to see the correlation between Borrower rate and Monthly Income that also showing quite strong correlation of -0.0691 in the first correlation matrix.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = StatedMonthlyIncome, y = BorrowerRate), 
       data = subset(loandata_completed, 
                     StatedMonthlyIncome < 30000 &
                       !is.na(ProsperRating..Alpha.) & 
                       ProsperRating..Alpha. != ''))+
  geom_point(alpha = 0.1)+
  stat_smooth(method = 'lm')

```


The lm line showing the negative trend between Stated Monthly Income and Borrower rate.
The hihger the monthly income, the lower the rate.


Next, I would like to see how the original loan amount varies by Prosper ratings.

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(aes(x = ProsperRating..Alpha., y = LoanOriginalAmount), 
       data = loandata_completed)+
  geom_boxplot()

```

* Loan amount seem to be ranged higher with better rating borrowers. With higher 
ratings between AA to C,  mdeians are more than 6,000.
* In contrast, with lower ratings between D, E and HR, median are 5,000 or less.

It becomes more obvious when comparing the total in number and in amount for 
each ratings.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### Count by ProsperRating..Alpha.
rating_pos <- c('AA','A','B','C','D','E','HR')
p1<-  ggplot(aes(x = ProsperRating..Alpha., fill = ProsperRating..Alpha.), 
       data = subset(loandata_completed, 
                     loandata_completed$ProsperRating..Alpha. !=''))+
  geom_bar()+
  scale_x_discrete(limits = rating_pos)

### Total amount by ProsperRating..Alpha.
p2 <- ggplot(aes(x = ProsperRating..Alpha., fill = ProsperRating..Alpha., 
           y = LoanOriginalAmount), 
       data = subset(loandata_completed, 
                     loandata_completed$ProsperRating..Alpha. !=''))+ 
  geom_col()+
  scale_x_discrete(limits = rating_pos)

grid.arrange(p1, p2, ncol = 1)
```

* This plot compares the the total number of borrowers and total amount of loan for each rating.
* Although the higher graded borrowers are alomost equal or relatively smaller than lower graded borrowers in number, they are much larger in loan amount.  

#### What are the difference between Completed loans and Defaulted/Charge-off loans?



Next, I would like to explore what factors could affect whether or not a loan is to be defaulted?

Firstly, I would like to look this by loan amount. 

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

### Histograms by Loan original amount by IsDefaulted

ggplot(aes(x = LoanOriginalAmount), data = loandata_completed)+
  geom_histogram()+
  scale_x_continuous(limits = c(0,15000))+
  facet_wrap(~IsDefaulted, ncol = 1)

```


* I was expecting to see more defaulted loans with the higher amount loans as I 
thought the more loan amount, the more difficult to complete repayment. 
* To my suprise, however, above histograms are showing similar distribution pattern.
There does not seem to be much difference in distribution by loan amount. 
* This suggests that loan amount alone is not a strong factor to determine 
whether or not th eloan is defaulted.



Next, I would like to look into the distribution by monthly payment amount.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### Histograms by monthly loan payment
ggplot(aes(x = MonthlyLoanPayment, fill = IsDefaulted), 
       data = subset(loandata_completed,
                     !is.na(loandata_completed$MonthlyLoanPayment)))+
  geom_histogram()+
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 50))+
  facet_wrap(~IsDefaulted, ncol=1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

### summary of monthly payment by IsDefaulted
by(loandata_completed$MonthlyLoanPayment, 
   loandata_completed$IsDefaulted, summary)
```

* There does not seem much difference in distribution, too.
* When looking at the summaries, monthly payment amount of defaulted/charge-off 
loans is slightly higher than completed loans. For completed loans, median is 171.10 and mean is 218.78 but for defaulted/charge-off loans, median is 173.7 and mean is 234.8.

What can we see if we look this from the borrower rate?

```{r echo=FALSE, message=FALSE, warning=FALSE}

### Histograms by Borrower rate
ggplot(aes(x = BorrowerRate, fill = IsDefaulted), data = loandata_completed)+
  geom_histogram()+
  facet_wrap(~IsDefaulted, ncol = 1)

```

Above plot compares the distribution by borrower rate.

* First histogram, representing completed loans, showing slight right skewed distiribution with its peak around 0.1. 
* On the other hand, the second histogram, representing defaulted/charge-off, 
showing left skewed distribution with its peak around 0.3.
* This is interesting to see that the defaulted loans are more likely with higher borrower 
rate.

As we have seen earlier, the borrower rate seems to be determined based on risk 
factors, such as Prosper rating and Prosper scores.

Let's have a look at the distribution by rating and score to see how it differs 
between completed loans and defaullted loans.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### distribution by Prosper rating
ggplot(aes(x = ProsperRating..Alpha.), data = subset(loandata_completed, ProsperRating..Alpha. != ''))+
  geom_bar()+
  facet_wrap(~IsDefaulted, ncol=1)+
    scale_x_discrete(limits = rating_pos)


### distribution by Prosper score
ggplot(aes(x = ProsperScore), data = loandata_completed)+
  geom_bar()+
  facet_wrap(~IsDefaulted, ncol=1)

by(loandata_completed$ProsperScore, loandata_completed$IsDefaulted, summary)
```

* First set of plots with distribution by Prosper rating, Defaulted/Charge-off 
distribution seem to be negatively skewed to lower ratings comparing to 
Completed loans.

** The proportion of AA and A seem to be much smaller for Defaulted/Charge-off 
loans than Completed loans. 

** Lower ratings such as E and HR have larger proportion with defaulted loans.

* Similar tendency can be seen with the second set of plots by Prosper scores.

** Defaulted/Charge-off loans has its peak around 5-6 whereas Completed loans has around 8.

** Summary shows 3rd quatile of Defaulted/charge-off loans is 7, whereas that of Completed loans is 8.





# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. 

How did the feature(s) of interest vary with other features in the dataset?

* There seems to be quite strong correlation between Borrower rate, Stated Monthly Income, Prosper rating, and Prosper score.
* Risk indicator such as ratings and scores seem to be showing some relation with whether or
not the loan is defaulted.
* It may make sense to interpret that higher loan rate makes it difficult for 
lower rating borrowers to borrow larger amount, since higher loan rate consequently increases the total repayment amount.

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

* Unfortunately I did not find any intersting relationships between the features other than the main features.

### What was the strongest relationship you found?

* Prosper Score and borrower rate and also Prosper rating and borrower rate are both showing quite strong correlation.




------


# Multivariate Plots Section


```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots}
### 
ggplot(aes(x = BorrowerRate, y = LoanOriginalAmount, 
             color = ProsperRating..Alpha.), 
       data = subset(loandata_completed, 
                     StatedMonthlyIncome < 30000 &
                       !is.na(ProsperRating..Alpha.) & 
                       ProsperRating..Alpha. != ''))+
  geom_jitter()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

* This plot shows how each Prosper Rating are distributed across loan amount and borrower rate. It seems to be indicating a tendency that the higher the borrower rate, the less amount borrower tend to borrow.
* Also it appears to be that the better the rating, the more amount borrowed.

I would like to look in the separated plots as below to see how the loan amount differs by 
Prosper rating.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = BorrowerRate, y = LoanOriginalAmount, 
           color = ProsperRating..Alpha.), 
       data = subset(loandata_completed, 
                     StatedMonthlyIncome < 30000 &
                       !is.na(ProsperRating..Alpha.) & 
                       ProsperRating..Alpha. != ''))+
  geom_jitter()+
  facet_wrap(~ProsperRating..Alpha.)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  stat_smooth(method = 'lm')


```

Seemingly, borrowers with higher rating tend to borrow more amount with lower rate than lower graded borrowers.

Do the borrower with better rating or score repay more?

```{r echo=FALSE, message=FALSE, warning=FALSE}

### scatter plot by borrower's income and monthly payment amount and score

ggplot(aes(x = StatedMonthlyIncome, y = MonthlyLoanPayment, 
            color = factor(ProsperScore)), 
       data = subset(loandata_completed, ProsperScore != 'NA')) +
  geom_jitter(alpha = 1/5)+
  scale_x_continuous(limits = c(0, 15000))+
  scale_y_continuous(limits = c(0, 1500))+
  facet_wrap(~IsDefaulted)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    stat_smooth(method = 'lm', color = 'orange')+
  scale_color_brewer(palette = 'Blues')+
  theme_dark()

### scatter plot by borrower's income and monthly payment amount and rating

ggplot(aes(x = StatedMonthlyIncome, y = MonthlyLoanPayment, 
            color = ProsperRating..Alpha.), 
       data = subset(loandata_completed, ProsperRating..Alpha. != '')) +
  geom_jitter()+
  scale_x_continuous(limits = c(0, 15000))+
  scale_y_continuous(limits = c(0, 1500))+
  facet_wrap(~IsDefaulted)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    stat_smooth(method = 'lm', color = 'orange')+
  scale_color_brewer(palette = 'Greens')+
  theme_dark()

```

* Though it is not too obvious from the plot, the smooth lm line is suggesting a trend 
that the higher the income, the more payment the borrowers are capable of.
* Completed loans are occasionally paying more than 1,000 per month, while the 
defaulted loans are not.


```{r echo=FALSE, message=FALSE, warning=FALSE}
### summary by monthly income and Isdefaulted
by(loandata_completed$StatedMonthlyIncome, loandata_completed$IsDefaulted, 
   summary)
```

* Summary shows mean monthly income of the completed loans are approximately 
900 higher than that of defaulted loans. Median is  approximately 700 higher.


Finally I would like to see how the defaulted loans are distributed across 
Prosper rating and Prosper score on below scatter plot.

```{r echo=FALSE, message=FALSE, warning=FALSE}

### scatter plot by rating, score and IsDefaulted
ggplot(aes(x = ProsperRating..Alpha.  , y = ProsperScore, 
           alpha = 1/100, color =ProsperRating..Alpha.), 
       data = subset(loandata_completed, ProsperRating..Alpha. != '')) +
  geom_jitter()+
  scale_color_brewer(type = 'div')+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_discrete(limits = rating_pos)+
  facet_wrap(~IsDefaulted)


ggplot(aes(x = ProsperRating..Alpha.  , y = ProsperScore, 
           color = IsDefaulted), 
       data = subset(loandata_completed, ProsperRating..Alpha. != '')) +
  geom_jitter(alpha = 0.8, size = 1)+
  scale_color_brewer(type = 'seq')+
  scale_x_discrete(limits = rating_pos)+
  scale_y_continuous(limits = c(0, 10))+
  scale_color_brewer(palette = 'Paired')+
  theme_dark()

```

* The last plot shows how Complted and Defaulted/Charge-off loans are 
distributed across Prosper score and Prosper Rating. 
* It is interesting that Defaulted/Charge-off loans are distributed relatively paler in higher score and rating, such as AA, A, and B.


# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

It seems Prosper rating and Prosper score have quite strong relation though it is difficult to say if this relation is strengthening each other. However, these 2 variables seems to be correaltes also with borrower rate.

### Were there any interesting or surprising interactions between features?

It is not surprising to see there is strong correlation between risk indicators 
and borrower rate.

### OPTIONAL: Did you create any models with your dataset? Discuss the \
strengths and limitations of your model.

N/A


------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_One}

### Histograms by Borrower rate
ggplot(aes(x = BorrowerRate, fill = IsDefaulted), data = loandata_completed)+
  geom_histogram()+
  facet_wrap(~IsDefaulted, ncol = 1)+
  labs(fill = '')+
  xlab('Borrower Rate')+
  ylab('Number of Loans')+
  ggtitle('Difference between completed and defaulted loans by Borrower rate')


```

### Description One

For defaulted loans, the borrower rate range is distributed more in higher rates, comparing to the completed loans.
This may suggest that the higher the loan rate, the more difficult for borrowers to complete the loan.



### Plot Two
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Two}

### Boxplot by Prosper Rating
b1 <- ggplot(aes(x = ProsperRating..Alpha., y = BorrowerRate), 
       data = loandata_completed)+
  geom_boxplot()+
  scale_x_discrete(limits = rating_pos)+
  xlab('Prosper Rating')+
  ylab('Borrower Rate')


### Boxplot by Prosper Score

b2 <-ggplot(aes(x = as.character(ProsperScore), y = BorrowerRate), 
            data = subset(loandata_completed, ProsperScore < 11))+
  geom_boxplot()+
  scale_x_discrete(limits = score_pos)+
  xlab('Prosper Score')+
  ylab('Borrower Rate')

grid.arrange(b1, b2, ncol = 1, 
             top = 'Borrower rate by Prosper Rating and Prosper Score')
```

### Description Two

Ratings and Scores seem to have quite strong correlation with borrower rate. These risk indicators semms to be used as a basis when determining borrower rate.



So, are these risk indicator effective to reduce the risk of default?

### Plot Three
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Three}
### multi plot rating, score, and isDefaulted

ggplot(aes(x = ProsperRating..Alpha.  , y = ProsperScore, 
           color = IsDefaulted), 
       data = subset(loandata_completed, ProsperRating..Alpha. != '')) +
  geom_jitter(alpha = 0.8, size = 1)+
  scale_color_brewer(type = 'seq')+
  scale_x_discrete(limits = rating_pos)+
  scale_y_continuous(limits = c(0, 10))+
    scale_color_brewer(palette = 'Paired')+
  theme_dark()+
  ggtitle('Defaulted loans distribution by Prosper Rating and Score')+
  xlab('Prosper Rating')+
  ylab('Prosper Score')+
  theme(legend.title=element_blank())



```

### Description Three

Seemingly, defaulted/charge-off loans are distributed more in lower ratings such as D, E, and HR. However, defaulted loans still can be seen even with higher ratings like AA or A.



# Reflection


* I was expecting to see much more distinct difference between completed loans and defaulted loans and was hoping to identify any deterministic factors that decides whether or not a loan goes default. But my research and analysis did not reveal much findings as interesting as I expected.
* Most surprised and intersting finding was that there still are quite a few defaulted loans even with top ratings like AA, A, though it is true that the ratings and scores seem to be working to reduce the risk to some extent. 
* Though my research did not explore, the charging higher rate to lower graded borrowers probably helps to optimize loan porpfolio.  

#### Future work: 

* In this report, analysis was conducted for closed loans aiming to find any patterns and any factors that may affect whether or not a loan could go default.
* As a future work, I am interested in making any prediction on how much portion of current loans could go default.
* If I could have some more details about this dataset, especially the factors that determine ratings and scores, it might have been possible to find the features that strengthened each other, that possibly help to make such prediction.


# Extra: Logistic Regression

After completed the Udacity nanodegree course, revisited this dataset with attempt to establish a logistic regression model.

```{r echo=TRUE, message=FALSE, warning=FALSE}

### prepare a sample dataset
set.seed(20022012)

### add new variable Defaulted by converting IsDefaulted to boolean

loandata_completed$Defaulted <- ifelse(
  loandata_completed$LoanStatus == 'Defaulted' | 
    loandata_completed$LoanStatus == 'Chargedoff', TRUE,
  FALSE)

loandata_completed_train<- subset(
  loandata_completed,
  select = c(LoanOriginalAmountRange, 
             BorrowerRate,
             StatedMonthlyIncomeRange,
             DebtToIncomeRatio, 
             MonthlyLoanPayment,
             ProsperScore,
             ProsperRating..Alpha.,
             CurrentCreditLines,
             EmploymentStatusDuration,
             OpenRevolvingAccounts, 
             OpenRevolvingMonthlyPayment,
             BankcardUtilization,
             RevolvingCreditBalance,
             AvailableBankcardCredit,
             TotalInquiries,
             CurrentDelinquencies,
             Term,
             IncomeVerifiable,
             CreditScoreRangeLower,
             Defaulted
             ))

###split data in to train and test dataset
library(caTools)
set.seed(144)
spl = sample.split(loandata_completed_train$Defaulted, 0.7)
train_set = subset(loandata_completed_train, spl == TRUE)
test_set = subset(loandata_completed_train, spl == FALSE)

```

```{r}
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
### fitting
#model <- glm(Defaulted~.,family=binomial(link='logit'),data=loandata_completed_train)
model <- glm(Defaulted~.,family=binomial(link='logit'),data=train_set)

```
### Interpretation

```{r echo=FALSE, message=FALSE, Interpretation}
summary(model)

### analyze table of deviance
anova(model, test="Chisq")

```

From the results:
* BorrowerRate and StatedMonthlyIncome have the lowest p-value of 2e-16. This suggests strong association of between these two variables and the probability of the loan to go default.
* EmploymentStatusDuration, IncomeVerifiable, and RevolvingCreditBalance have less correlation.

```{r}
```
Memo: 
* When running anova(), first attempt caused perfect separation warning and LoanOriginalAmount seems to be responsible for this warning.
* Applied binning on LoanOriginalAmount, but still throwing the warning. StatedMonthlyIncome also seems to be causing this warning.
* After binning both LoanOriginalAmount and StatedMonthlyIncome, the warning is no longer thrown. 


### Assessing the predictive ability of the model

```{r}
### predict
fitted.results <- predict(model,newdata=test_set,type='response')
```

```{r}
### examine accuracy
threshold = 0.5

fitted.results <- ifelse(fitted.results > threshold,1,0)
misClasificError <- mean(fitted.results != test_set$Defaulted)

print(paste("Misclacific err::",misClasificError))
print(paste('Accuracy',1-misClasificError))

# compute McFadden R2

print("R2: ")
pR2(model)


### Confusion Matrix
confusion_matrix <- table(test_set$Defaulted, as.numeric(fitted.results >= threshold))

cat("\n")
print("Confusion Matrix: ")
confusion_matrix

tn <- confusion_matrix[1]
fn <- confusion_matrix[2]
fp <- confusion_matrix[3]
tp <- confusion_matrix[4]

cat("\n")

print(paste('True Negative: ',tn))
print(paste('False Negative: ',fn))
print(paste('False Positive: ',fp))
print(paste('True Positive: ',tp))

print(paste('Recall: ', tp/(tp + fn)))
print(paste('Precision: ',tp/(tp + fp)))

# accuracy based on above confusion matrix
print(paste('Accuracy:', (tn + tp)/sum(confusion_matrix)))

```

We got accuracy of 72.4%
Let's examine the accuracy by conducting coross validation.

### Cross Validation
```{r}

predictors_vector <- c("BorrowerRate", "DebtToIncomeRatio","LoanOriginalAmountRange","StatedMonthlyIncomeRange","MonthlyLoanPayment",
"ProsperScore","ProsperRating..Alpha.",
"CurrentCreditLines","EmploymentStatusDuration","Term",
"BankcardUtilization","RevolvingCreditBalance","AvailableBankcardCredit","TotalInquiries","CurrentDelinquencies"
)

predictors_vector_sum <- paste(predictors_vector, collapse="+")
logReg_model_fmla <- as.formula(paste("Defaulted ~ ", predictors_vector_sum))

fitControl = trainControl( method = "cv", number = 10, p = 0.70 )

### Convert `Defaulted` column from boolean to factor
#train_set$Defaulted <-as.integer(as.logical(train_set$Defaulted))
train_set$Defaulted <-as.factor(as.logical(train_set$Defaulted))

logReg_model_cv <- train(logReg_model_fmla, data=train_set, method = "bayesglm", trControl = fitControl)

logReg_model_cv$resample$Accuracy
mean(logReg_model_cv$resample$Accuracy)
```

Above cross validation results seem to match the predicted accuracy of 72.4%.

### ROC and AUC
```{r}

p <- predict(model, newdata=test_set, type="response")
pr <- prediction(p, test_set$Defaulted)

# Performance function
prf <- performance(pr, measure = "tpr", x.measure = "fpr")

# Plot ROC curve
plot(prf,colorize=TRUE,print.cutoffs.at=seq(0,1,by=0.1), text.adj=c(-0.2,1.7))
grid()

# AUC
auc <- performance(pr, measure = "auc")
auc <- auc@y.values[[1]]
print(paste("AUC:", auc))

# Recall-Precision curve
prf <- performance(pr, measure = "prec", x.measure = "rec")
plot (prf);

# F1 score
prf <- performance(pr, "f")
plot (prf);
```


### Optimization
We have used threshold of 0.5 in previous analysis and we succeeded in identifying 1,540 true positives, but still missing 3,563 false positives.

Let's see if changing threshold improve the prediction ability.

```{r}
fitted.results <- predict(model,newdata=test_set,type='response')

thresholds <- seq(0.1,1.0,by=0.05)

for(threshold in thresholds){
  results.over.threshold <- ifelse(fitted.results > threshold,1,0)
  misClasificError <- mean(results.over.threshold != test_set$Defaulted)
  mean(results.over.threshold)

  confusion_matrix <- table(test_set$Defaulted, as.numeric(results.over.threshold >= threshold))

  print(paste('Threshold: ',threshold))
  print(confusion_matrix)

  print(misClasificError)
  print(paste('Accuracy',1-misClasificError))
  
  tn <- confusion_matrix[1]
  fn <- confusion_matrix[2]
  fp <- confusion_matrix[3]
  tp <- confusion_matrix[4]
  
  print(paste('False Negative: ',fn))
  print(paste('True Positive: ',tp))
  
  recall <- tp/(tp + fn)
  precision <- tp/(tp + fp)
  f1 <- 2* precision * recall /(precision + recall)
  print(paste('Recall: ', recall))
  
  print(paste('Precision: ',precision))
  print(paste('F1: ',f1))
  cat("\n")
  }
```

Threshold of 0.4 seems to score most balanced result, we have F1 score of 0.51 that is closest to 0.5, precision higher than 0.5, and also accuracy higher than 71%.

